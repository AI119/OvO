## 关联分析定义
在美国有婴儿的家庭中，通常是母亲在家中照看婴儿，父亲去超市为婴儿购买尿布。当丈夫在为孩子购 买尿布的同时，也通常购买自己爱喝的啤酒。因此，沃尔玛超市发现这一规律后，将啤酒与尿布放在相 同的区域，使得父亲可以同时买到这两件商品，从而提高啤酒与尿布的销售量。

关联分析，就是从大规模数据中，发现对象之间隐含关系与规律的过程，也称为关联规则学习。例如，{啤 酒 -> 尿布}就是一个关联规则。

## 应用场景
+ 超市购物分析 
+ 图书购买分析 
+ 服装搭配分析 
+ 交通事故分析 
+ 疾病症状分析 
+ 社交关系分析

## 关联分析相关概念

### **项与项集 

项，指我们分析数据中的一个对象。而项集就是由若干项构成的集合。

### **支持度

支持度为某项集在数据集中出现的频率。即项集在记录中出现的次数，除以数据集中所有记录的数量。
$$
\operatorname{support}(A)=\frac{\operatorname{count}(A)}{\operatorname{count}(\text { dataset })}=P(A)
$$


### **置信度**
关联规则{A -> B}中，置信度为A与B同时出现的次数，除以A出现的次数。
$$
\begin{aligned}
& \operatorname{con} \text { fidence }(A->B)=\frac{\operatorname{count}(A B)}{\operatorname{count}(A)} \\
& =\frac{\operatorname{count}(A B) / \operatorname{count}(\text { dataset })}{\operatorname{count}(A) / \operatorname{count}(\text { dataset })} \\
& =\frac{P(A B)}{P(A)} \\
& =P(B \mid A)
\end{aligned}
$$
置信度体现的是关联规则的可靠程度，如果关联规则{A -> B}的置信度较高，则说明当A发生时，B有很 大概率也会发生，这样就可能会带来研究价值。

### **提升度**
关联规则{A -> B}中，提升度为{A -> B}的置信度，除以B的支持度。
$$
\begin{aligned}
& \text { lift }(A->B)=\frac{\text { confidence }(A->B)}{\text { support }(B)} \\
& =\frac{P(B \mid A)}{P(B)} \\
& =\frac{P(A B)}{P(A) P(B)}
\end{aligned}
$$

### 频繁项集
通常情况下，我们只会对频繁出现的项集进行研究。因此，我们会设置一个支持度阈值，如果一个项集 的支持度达到（大于等于）该阈值，则该项集就称为频繁项集。特别的，如果频繁项集中含有$k$个元素，我们称之为频繁$k$项集。

## 关联分析过程 
关联分析可以分为如下两个过程： 
1. 从数据集中寻找频繁项集。 
2. 从频繁项集中生成关联规则。

## 寻找频繁项集
------------------
首先，我们需要能够找到所有的频繁项集，即经常出现在一起的对象集合。实际上，找到频繁项集并不 复杂，我们只需要按照如下的步骤来进行操作即可： 
1. 遍历对象之间所有可能的组合（包括单个对象的组合），每种组合构成一个项集。 
2. 针对每一个项集A，计算A的支持度（A出现的次数除以记录总数）。 
3. 返回所有支持度大于指定阈值的项集。
![[Pasted image 20230531093647.png]]

### Apriori算法原理
以上的理论是没有问题的，但是，却很难在实际应用中使用。因为，对象之间任意组合构成的项集，数 量可能非常大。例如，在上图中，4个不同的对象（项），就可以构成15种组合。而对于含有 个对象 的数据集，总共可以构成$2^N-1$种组合，这是一个非常大的数字。
因此，为了降低计算量，我们使用Apriori算法原理进行优化。Apriori算法原理可以解释如下： 
1. 如果一个项集是频繁项集，则其所有子集（非空）也是频繁项集。 
2. 如果一个项集（非空）是非频繁项集，则其所有父集也是非频繁项集。
Apriori算法会从$k-1$开始，使用两个$k$项集进行组合，从而产生$k+1$项集。结合之前介绍的算法原理，我们可知，频繁$k+1$项集是由两个$k$项集组合而成，而对于频繁$k+1$项集来说，其所有的$k$项集子集必然都是频繁项集，这就意味着，频繁$k+1$项集只可能从两个频繁$k$项集组合产生，因此，当我们在 组合的过程中，一旦发现某个$k$项集不是频繁项集（支持度小于指定的阈值），就可以将其移除，而无 需再参与后续生成$k+1$项集的组合。这样一来，就可以大大减少计算量。 例如在图中，假设{2，3}是非频繁项集，则根据Apriori算法原理，其所有父集也是非频繁项集，故 {0,2,3}，{1,2,3}与{0,1,2,3}也是非频繁项集。因此，我们就无需使用{2，3}与其他2项集进行组合，去生 成3项集了（因为生成的所有3项集都是非频繁项集）。
例如在图中，假设{2，3}是非频繁项集，则根据Apriori算法原理，其所有父集也是非频繁项集，故 {0,2,3}，{1,2,3}与{0,1,2,3}也是非频繁项集。因此，我们就无需使用{2，3}与其他2项集进行组合，去生 成3项集了（因为生成的所有3项集都是非频繁项集）。
![[Pasted image 20230531095418.png]]

### Apriori算法流程
Apriori算法流程如下:
1. 扫描数据集，从数据集中生成候选 $k$ 项集 $C_k(k$ 从1开始）。
2. 计算 $C_k$ 中，每个项集的支持度，删除低于阈值的项集，构成频繁项集 $L_k$ 。
3. 将频繁项集 $L_k$ 中的元素进行组合，生成候选 $k+1$ 项集 $C_{k+1}$
4. 重复步骤2,3，直到满足以下两个条件之一时，算法结束。
+ 频繁 $k$ 项集无法组合生成候选 $k+1$ 项集。
+ 所有候选 $k$ 项集支持度都低于指定的阈值（最小支持度），无法生成频繁 $k$ 项集。

说明:
- $C_k$ : 所有的候选 $k$ 项集
- $L_k$ : 所有的频繁 $k$ 项集。

### 生成关联规则
当产生频繁项集后，生成关联规则会相对简单。我们只需要将每个频繁项集拆分成两个非空子集，然后 使用这两个子集，就可以构成关联规则。当然，一个频繁项集拆分两个非空子集可能有很多种方式，我 们要考虑每一种不同的可能。例如，频繁项集{1, 2, 3}可以拆分为：

{1 -> 2, 3} 
{2 -> 1, 3} 
{3 -> 1, 2} 
{1, 2 -> 3} 
{1, 3 -> 2} 
{2, 3 -> 1}

之后对每一个关联规则，分别计算其置信度，仅保留符合最小置信度的关联规则。

## 程序实现

### 安装efficient-apriori库

安装
`pip install efficient-apriori`

这个库用于频繁项集挖掘和关联规则挖掘。它提供了一个高效的 Apriori 算法实现，用于从事务数据集中发现频繁项集和关联规则。

### 加载数据集
首先，从文件中读取数据
``` python
def load_data(path): 
"""读取指定路径的文件。 
Parameters 
---------- 
path : str
	文件所在的路径。 
Returns 
------- 
content : list 
	文件的内容。 
	""" 
	content = [] 
	with open(path, encoding="UTF-8") as f: 
		for line in f: 
			line = line.strip("\n") 
			content.append(line.split(",")) 
	return content

# dataset是一个二维列表，每个元素（一维列表）保存每个购物清单的商品记录。 
dataset = load_data("data.txt") 
print(len(dataset))
```

![[Pasted image 20230531203100.png]]

``` python
# print(dataset[:10]) 
for i in range(10): 
	print(i + 1, dataset[i], sep="->")
```

![[Pasted image 20230531203119.png]]
读取前十条数据

### 挖掘关联规则
可以通过Aprilori算法发现关联规则。
``` python
from efficient_apriori import apriori 
# transactions：交易数据，要求为二维数据结构，每个低维用来存放每个购物清单的商品。 
# min_support：最小支持度。
# min_confidence：最小置信度。 
# 该函数会返回满足条件的频繁项集与关联规则。 
itemsets, rules = apriori(transactions=dataset, min_support=0.05, min_confidence=0.3) 
# 输出所有满足条件频繁k项集。 
print(itemsets) 
# 输出关联规则。 
print(rules)
```

![[Pasted image 20230531203929.png]]

apriori函数返回的关联规则列表，每个元素efficient_apriori.rules.Rule类型。我们可以输出这些对 象，能看到更加详细的信息:
- **支持度**
- **置信度**
- **提升度**
- **确信度**
其中，给定关联规则 $\{A-B\}$ ，确信度的计算方式为:
 $$conviction(A->B)=\frac{1-\operatorname{support}(B)}{1-\operatorname{confidence}(A->B)}=\frac{P(\bar{B})}{P(\bar{B} \mid A)}$$

如果一个关联规则的确信度大，则表示该规则的置信度大，并且 $B$ 经常出现。

``` python
for r in rules: 
	print(r)
```
![[Pasted image 20230531204200.png]]
此外，我们还可以通过Rule类提供的属性，来获取对应的信息值。
``` python
r = rules[0] 
print("支持度：", r.support) 
print("置信度：", r.confidence) 
print("提升度：", r.lift) 
print("确信度：", r.conviction)
```
![[Pasted image 20230531204243.png]]
